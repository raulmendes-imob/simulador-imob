<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro | Simulador Imob</title>
</head>
<body>

  <h1>Cadastro com código</h1>

  <form id="registerForm">
    <div>
      <label for="email">E-mail</label><br />
      <input type="email" id="email" required />
    </div>

    <br />

    <div>
      <label for="password">Senha</label><br />
      <input type="password" id="password" required />
    </div>

    <br />

    <div>
      <label for="code">Código de acesso</label><br />
      <input type="text" id="code" required />
    </div>

    <br />

    <button type="submit">Criar conta</button>
  </form>

  <p id="error" style="color:red;"></p>

  <!-- Firebase -->
  <script type="module" src="/simulador-imob/app/js/firebase.js"></script>

  <!-- Cadastro com acesso de 1 ano -->
  <script type="module">
    import {
      doc,
      getDoc,
      updateDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    import {
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const form = document.getElementById("registerForm");
    const errorEl = document.getElementById("error");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.textContent = "";

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const code = document.getElementById("code").value.trim();

      if (!email || !password || !code) {
        errorEl.textContent = "Preencha todos os campos.";
        return;
      }

      try {
        const db = window.firebaseDb;
        const auth = window.firebaseAuth;

        // 1️⃣ Validar código
        const inviteRef = doc(db, "invites", code);
        const inviteSnap = await getDoc(inviteRef);

        if (!inviteSnap.exists()) {
          errorEl.textContent = "Código inválido.";
          return;
        }

        const invite = inviteSnap.data();

        if (!invite.active) {
          errorEl.textContent = "Código desativado.";
          return;
        }

        if (invite.used) {
          errorEl.textContent = "Código já utilizado.";
          return;
        }

        // 2️⃣ Criar usuário no Auth
        const userCredential =
          await createUserWithEmailAndPassword(auth, email, password);

        const user = userCredential.user;

        // 3️⃣ Calcular acesso de 1 ano
        const accessUntil = new Date();
        accessUntil.setFullYear(accessUntil.getFullYear() + 1);

        // 4️⃣ Criar documento do usuário
        await setDoc(doc(db, "users", user.uid), {
          email: email,
          role: "buyer",
          status: "active",
          inviteCode: code,
          accessUntil: accessUntil,
          createdAt: serverTimestamp()
        });

        // 5️⃣ Marcar código como usado
        await updateDoc(inviteRef, {
          used: true,
          emailBound: email,
          usedAt: serverTimestamp()
        });

        // 6️⃣ Redirecionar
        window.location.href = "/simulador-imob/app/dashboard.html";

      } catch (err) {
        console.error(err);

        if (err.code === "auth/email-already-in-use") {
          errorEl.textContent = "Este e-mail já está cadastrado.";
        } else if (err.code === "auth/weak-password") {
          errorEl.textContent = "A senha deve ter pelo menos 6 caracteres.";
        } else {
          errorEl.textContent = "Erro ao criar conta.";
        }
      }
    });
  </script>

</body>
</html>
